<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">
<head>
	<title>Formulario Sala</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
	<script src="https://kit.fontawesome.com/adb5bd4540.js" crossorigin="anonymous"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/js/tempusdominus-bootstrap-4.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/css/tempusdominus-bootstrap-4.min.css" />

	<script th:inline="javascript">
	function buscarSalas() {
		var url = [[${@rutas.EVENTOS_BUSQ_SALAS}]];
		var busqueda = $('#busqueda').val();
		var valor = $('#valor').val();
		
		url += "?paramBusq=";
		if (busqueda) {
			url += busqueda;
		} 
		url += "&valorBusq=";
		if (valor) {
			url += valor;
		}
		$('#lista_salas').empty();
		$('#lista_salas').load(url, hoverSalas);
	}
	
	function setSala(sala) {
		$('#inputSala').val($(sala).data("nombre"));
		$('#idSala').val($(sala).data("idsala"));
		$('#maxUsuarios').text($(sala).data("aforo"));
		$('#salasModal').modal('toggle');
		$('#listaUsuarios').show();
		$('#filtrarUsuarios').prop("disabled", false);
		$('#filtrarUsuarios').attr("placeholder", "Buscar por nombre");
	}
	
	function validarMaxUsuarios() {
		var maxUsuarios = $("#maxUsuarios").text();
		var nUsuarios = $("#nUsuarios").text();
		if($(this).is(':checked')) {
			nUsuarios++;
			if (maxUsuarios == nUsuarios) {
				$("#listaUsuarios input:checkbox:not(:checked)").prop('disabled', true);
			}
		} else {
			nUsuarios--;
			if ((maxUsuarios-1) == nUsuarios) {
				$("#listaUsuarios input:checkbox:not(:checked)").prop('disabled', false);
			}
		}
		$("#nUsuarios").text(nUsuarios);	
	}
	
	function hoverSalas(){
		$('#accordion > .card').hover(
			function(){
				$(this).children(".card-header").addClass("bg-primary");
			},
			function(){
				$(this).children(".card-header").removeClass("bg-primary");
			}
		);
	}
	
	$(function () {
		$('.dtp').datetimepicker({
			format: 'DD/MM/YYYY HH:00'
		});
		$("#listaUsuarios input:checkbox").change(validarMaxUsuarios);
		$('#listaUsuarios').hide();
		$('#inputSala').click(buscarSalas);
		$('#btn_buscar').click(buscarSalas);
		$('#horario1').addClass('show');
		$("#filtrarUsuarios").on("keyup", function() {
			var value = $(this).val().toLowerCase();
			$("#listaUsuarios li").filter(function() {
				$(this).toggle($(this).children("div").children("label").text().toLowerCase().indexOf(value) > -1)
			});
		});
	});
	</script>
</head>
<body class="bg-light" style="height: 100vh">
   	<div th:insert="fragmentos :: navbar"></div>
   	<div class="container mx-auto my-5 px-ms-5 h-100">
   		<form class="px-md-5 mx-lg-5" th:object="${__${@atributos.EVENTO}__}" th:action="@{__${@rutas.EVENTOS_GUARDAR}__}" method="post">
           	<h1 class="mb-3 ml-n2">Evento</h1>
           	<div th:if="${#fields.hasErrors('*')}" class="alert alert-danger alert-dismissible pt-4">
           		<button type="button" class="close" data-dismiss="alert">&times;</button>
		        <ul>
		            <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
		        </ul>
		    </div>
				
		    <input type="hidden" th:field="*{estado}"> 
		    <input type="hidden" id="idSala" name="idSala"> 

			<div class="form-group">
				<label for="nombre">Titulo:</label>
				<input th:field="*{nombre}" type="text" class="form-control" th:errorclass="border-danger">
			</div>
			
			<div class="form-group">
				<label for="nombre">Sala:</label>
				<input id="inputSala" type="text" class="form-control" data-toggle="modal" data-target="#salasModal" readonly>
			</div>
			
			<div class="form-group">
				<label>Usuarios: <span id="nUsuarios">0</span>/<span id="maxUsuarios">0</span></label>
				<input class="form-control" id="filtrarUsuarios" type="text" placeholder="Primero seleccione una sala" disabled>
				<ul class="list-group" id="listaUsuarios">
					<li th:each="usuario : ${__${@atributos.USUARIOS}__}" class="list-group-item">
						<div class="ml-3">
							<input th:id="${'usuario'+usuario.idUsuario}" name="usuarios" th:value="${usuario.idUsuario}"
							 class="custom-control-input" type="checkbox">
							<label th:for="${'usuario'+usuario.idUsuario}" class="custom-control-label"
							 th:text="${#strings.capitalizeWords(usuario.nombre)+' '+#strings.capitalizeWords(usuario.apellidos)}">
							</label>
						</div>
						
					</li>
				</ul>
			</div>
			
			<label>Horarios:</label>
			<div id="accordion" class="mb-3">
				<div th:with="n=${1}" th:insert="fragmentos :: horario"></div>
				<div th:with="n=${2}" th:insert="fragmentos :: horario"></div>
				<div th:with="n=${3}" th:insert="fragmentos :: horario"></div>
			</div>

			<div th:insert="fragmentos :: guardar-salir"></div>
        </form>
	</div>
	
	<!-- Modal con la busqueda y selecciÃ³n de sala -->
	<div class="modal fade" id="salasModal">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Salas</h4>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				
				<div class="modal-body">
					<div th:with="isSala=${'true'}, ruta=${'false'}" th:insert="fragmentos :: buscar"></div>
					<div id="lista_salas" class="my-5"></div>
				</div>
				
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
				</div>
			</div>
		</div>
	</div>
	
</body>
</html>